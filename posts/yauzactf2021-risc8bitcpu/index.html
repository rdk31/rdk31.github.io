<!doctype html><html><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title> rdk31's blog </title><link href=https://rdk31.com/fonts.css rel=stylesheet><script async data-goatcounter=https://rdk31.goatcounter.com/count src=https://rdk31.com/js/count.js></script><noscript><img src="https://rdk31.goatcounter.com//count?p=/posts/yauzactf2021-risc8bitcpu/&t=YauzaCTF 2021 - RISC 8bit CPU"></noscript><link title="rdk31's blog" href=https://rdk31.com/atom.xml rel=alternate type=application/atom+xml><link href=https://rdk31.com/theme/light.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=https://rdk31.com/theme/dark.css rel=stylesheet><link href=https://rdk31.com/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://rdk31.com>rdk31's blog</a></div><nav><a style="margin-left: 0.7em" href=/posts>/posts</a><a style="margin-left: 0.7em" href=/tags>/tags</a><a style="margin-left: 0.7em" href=/about>/about</a></nav></header><main><article><div class=title><div class=page-header>YauzaCTF 2021 - RISC 8bit CPU<span style="font-size: 1.6em" class=primary-color>.</span></div><div class=meta>Posted on 2021-08-31</div></div><section class=body><h1 id=task-description>Task description</h1><p>The SFT0 CPU is a secure processor designed to store encryption key. Find out how the processor works and get the key.<p><a href=files/manual.pdf>manual.pdf</a> <a href=files/rom.bin>rom.bin</a><h1 id=solution>Solution</h1><p>This is a simple CPU architecture containing 3 8bit registers, a pc register and 1bit flag register (zero flag). The instructions are 4 bytes in big endian.<p>And this is the emulator.<pre class=language-py3 data-lang=py3 style=background-color:#2b303b;color:#c0c5ce;><code class=language-py3 data-lang=py3><span style=color:#b48ead;>import </span><span>re
</span><span>
</span><span>pc = </span><span style=color:#d08770;>0x1000
</span><span>regs = [</span><span style=color:#d08770;>0</span><span>] * </span><span style=color:#d08770;>3
</span><span>fr = </span><span style=color:#d08770;>0
</span><span>halt = </span><span style=color:#d08770;>False
</span><span>
</span><span>rom = </span><span style=color:#96b5b4;>open</span><span>("</span><span style=color:#a3be8c;>rom.bin</span><span>", "</span><span style=color:#a3be8c;>rb</span><span>").</span><span style=color:#bf616a;>read</span><span>()
</span><span>ram = </span><span style=color:#bf616a;>bytearray</span><span>(rom) + </span><span style=color:#bf616a;>bytearray</span><span>([</span><span style=color:#d08770;>0</span><span>] * (</span><span style=color:#d08770;>0xFFFF </span><span>- </span><span style=color:#96b5b4;>len</span><span>(rom)))
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>add</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>val</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs
</span><span>    regs[reg] += val
</span><span>    regs[reg] &= </span><span style=color:#d08770;>0xFF
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>xor</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>val</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs
</span><span>    regs[reg] ^= val
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>and_op</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>val</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs
</span><span>    regs[reg] &= val
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>or_op</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>val</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs
</span><span>    regs[reg] |= val
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>ld</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>val</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs
</span><span>    regs[reg] = val
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>mov</span><span>(</span><span style=color:#bf616a;>reg1</span><span>, </span><span style=color:#bf616a;>reg2</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs
</span><span>    regs[reg1] = regs[reg2]
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>ldr</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>addr</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs, ram
</span><span>    regs[reg] = int.</span><span style=color:#bf616a;>from_bytes</span><span>(ram[addr], </span><span style=color:#bf616a;>byteorder</span><span>="</span><span style=color:#a3be8c;>big</span><span>")
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>ldr2</span><span>(</span><span style=color:#bf616a;>reg</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs, ram
</span><span>    addr = regs[</span><span style=color:#d08770;>1</span><span>] << </span><span style=color:#d08770;>8 </span><span>| regs[</span><span style=color:#d08770;>2</span><span>]
</span><span>    regs[reg] = ram[addr]
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>str_op</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>addr</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs, ram
</span><span>    ram[addr] = int.</span><span style=color:#bf616a;>to_bytes</span><span>(regs[reg], </span><span style=color:#bf616a;>byteorder</span><span>="</span><span style=color:#a3be8c;>big</span><span>")
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>str2_op</span><span>(</span><span style=color:#bf616a;>reg</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs, ram
</span><span>    addr = regs[</span><span style=color:#d08770;>1</span><span>] << </span><span style=color:#d08770;>8 </span><span>| regs[</span><span style=color:#d08770;>2</span><span>]
</span><span>    ram[addr] = regs[reg]
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>put</span><span>(</span><span style=color:#bf616a;>reg</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs, out
</span><span>    </span><span style=color:#96b5b4;>print</span><span>(</span><span style=color:#96b5b4;>chr</span><span>(regs[reg]), </span><span style=color:#bf616a;>end</span><span>="")
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>jmp</span><span>(</span><span style=color:#bf616a;>addr</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>pc
</span><span>    pc = addr
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>jnz</span><span>(</span><span style=color:#bf616a;>addr</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>pc, fr
</span><span>    </span><span style=color:#b48ead;>if </span><span>fr == </span><span style=color:#d08770;>0</span><span>:
</span><span>        pc = addr
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>jz</span><span>(</span><span style=color:#bf616a;>addr</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>pc, fr
</span><span>    </span><span style=color:#b48ead;>if </span><span>fr == </span><span style=color:#d08770;>1</span><span>:
</span><span>        pc = addr
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>cmpeq</span><span>(</span><span style=color:#bf616a;>reg</span><span>, </span><span style=color:#bf616a;>val</span><span>):
</span><span>    </span><span style=color:#b48ead;>global </span><span>regs, fr
</span><span>    </span><span style=color:#b48ead;>if </span><span>regs[reg] == val:
</span><span>        fr = </span><span style=color:#d08770;>1
</span><span>    </span><span style=color:#b48ead;>else</span><span>:
</span><span>        fr = </span><span style=color:#d08770;>0
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>hlt</span><span>():
</span><span>    </span><span style=color:#b48ead;>global </span><span>halt
</span><span>    halt = </span><span style=color:#d08770;>True
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>nop</span><span>():
</span><span>    </span><span style=color:#b48ead;>pass
</span><span>
</span><span>
</span><span>ops = {
</span><span>    "</span><span style=color:#a3be8c;>add</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span>", add],
</span><span>    "</span><span style=color:#a3be8c;>xor</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x01</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span>", xor],
</span><span>    "</span><span style=color:#a3be8c;>and</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x02</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span>", and_op],
</span><span>    "</span><span style=color:#a3be8c;>or</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x03</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span>", or_op],
</span><span>    "</span><span style=color:#a3be8c;>ld</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x04</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span>", ld],
</span><span>    "</span><span style=color:#a3be8c;>mov</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x05</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span>", mov],
</span><span>    "</span><span style=color:#a3be8c;>ldr</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x06</span><span style=color:#a3be8c;>(.)(..)</span><span>", ldr],
</span><span>    "</span><span style=color:#a3be8c;>ldr2</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x07</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00\x00</span><span>", ldr2],
</span><span>    "</span><span style=color:#a3be8c;>str</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x08</span><span style=color:#a3be8c;>(.)(..)</span><span>", str_op],
</span><span>    "</span><span style=color:#a3be8c;>str2</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x09</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00\x00</span><span>", str2_op],
</span><span>    "</span><span style=color:#a3be8c;>put</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x0A</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00\x00</span><span>", put],
</span><span>    "</span><span style=color:#a3be8c;>jmp</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x0B\x00</span><span style=color:#a3be8c;>(..)</span><span>", jmp],
</span><span>    "</span><span style=color:#a3be8c;>jnz</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x0C\x00</span><span style=color:#a3be8c;>(..)</span><span>", jnz],
</span><span>    "</span><span style=color:#a3be8c;>jz</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x0D\x00</span><span style=color:#a3be8c;>(..)</span><span>", jz],
</span><span>    "</span><span style=color:#a3be8c;>cmpeq</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x0E</span><span style=color:#a3be8c;>(.)</span><span style=color:#96b5b4;>\x00</span><span style=color:#a3be8c;>(.)</span><span>", cmpeq],
</span><span>    "</span><span style=color:#a3be8c;>hlt</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x44\x44\x44\x44</span><span>", hlt],
</span><span>    "</span><span style=color:#a3be8c;>nop</span><span>": [</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#96b5b4;>\x33\x33\x33\x33</span><span>", nop],
</span><span>}
</span><span>
</span><span>
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>parse</span><span>(</span><span style=color:#bf616a;>op</span><span>):
</span><span>    </span><span style=color:#b48ead;>for </span><span>k, v </span><span style=color:#b48ead;>in </span><span>ops.</span><span style=color:#bf616a;>items</span><span>():
</span><span>        r = re.</span><span style=color:#bf616a;>search</span><span>(v[</span><span style=color:#d08770;>0</span><span>], op)
</span><span>        </span><span style=color:#b48ead;>if </span><span>r:
</span><span>            v[</span><span style=color:#d08770;>1</span><span>](*[int.</span><span style=color:#bf616a;>from_bytes</span><span>(x, </span><span style=color:#bf616a;>byteorder</span><span>="</span><span style=color:#a3be8c;>big</span><span>") </span><span style=color:#b48ead;>for </span><span>x </span><span style=color:#b48ead;>in </span><span>r.</span><span style=color:#bf616a;>groups</span><span>()])
</span><span>            </span><span style=color:#b48ead;>break
</span><span>
</span><span>
</span><span style=color:#b48ead;>while </span><span>not halt:
</span><span>    </span><span style=color:#bf616a;>parse</span><span>(ram[pc : pc + </span><span style=color:#d08770;>4</span><span>])
</span><span>
</span><span>    pc += </span><span style=color:#d08770;>4
</span></code></pre><p>Running the emulator prints out the flag:<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>
</span><span>                                                        @@@@@@@*
</span><span>                                                    @@@@@       &@@@@
</span><span>        @@@@@@@@@@(@@@@@@@@@@ @@@@@@@@@@(@@@@@@@@@@ @@               @@@
</span><span>        @@@@@@@&  (@@@           @@@%   (@@  @@/@@@ @@   @       @(  @@@
</span><span>        #@@@@@@@@(@@@ @@@@@@    @@@%   (@@ @@  @@@ @@   @        ,@ @@@
</span><span>        @@@@@@@@@@(@@@           @@@%   (@@@@@@@@@@ @@               @@@
</span><span>                                                    @@@@@       /@@@@
</span><span>                                                    @@  @@@@@@@&
</span><span>                                                    @@@@
</span><span>                                                @@@@@
</span><span>                                                @@@@
</span><span>                                                &@
</span><span>
</span><span>    Top secret.
</span><span>    Authorized personnel only.
</span><span>    YauzaCTF{s0_s3cr3t_y3t_s0_fr33}
</span></code></pre><p>Interestingly enough, this emulator has a bug that I haven't noticed until the task author notified everybody that he had made a mistake creating the rom file. In my code, I increment pc after each op. That means also after a successful jump, skipping the first instruction after it. Luckily, the author had made the same mistake creating the file, so it canceled out.</section></article></main><div class=post-footer><div class=post-tags>tags: <a href=https://rdk31.com/tags/ctf/>#ctf</a></div><div class=post-nav><a class=previous href=https://rdk31.com/posts/first-post/>‹ Hello world!</a><a class=next href=https://rdk31.com/posts/yauzactf2021-arc6969p2/>YauzaCTF 2021 - ARC6969 P.2 ›</a></div></div></div>